---
interface Props {
	initialSection?: "gallery" | "services" | "contact" | "about";
	initialTag?: string;
	heroImageUrl?: string;
	heroImageAlt?: string;
}
const { initialSection, initialTag = "", heroImageUrl, heroImageAlt = "" } = Astro.props;
---

<!-- Hero -->
<section
	id="hero"
	data-page="hero"
	class="min-w-[100vw] w-[100vw] min-h-full flex-shrink-0 snap-start flex flex-col justify-start items-center pt-[15vh] px-4 sm:px-6 lg:px-8 relative overflow-hidden"
>
	<div id="hero-image-wrap" class="absolute inset-0 z-0">
		{heroImageUrl && (
			<>
				<img
					id="hero-image"
					src={heroImageUrl}
					alt={heroImageAlt}
					class="w-full h-full object-cover"
				/>
				<div class="absolute inset-0 bg-stone-900/50" aria-hidden="true" />
			</>
		)}
	</div>
	<div id="hero-content" class:list={["max-w-4xl mx-auto text-center relative z-10 w-full", heroImageUrl && "text-white"]}>
		<div id="hero-text-wrap" class="min-h-[7.5rem] flex flex-col justify-center">
			<h1 id="hero-title" class:list={["font-serif text-5xl sm:text-6xl lg:text-7xl font-light leading-tight tracking-tight min-h-[3.5rem] sm:min-h-[4rem] lg:min-h-[4.5rem] transition-opacity duration-300", heroImageUrl ? "text-white" : "text-stone-900"]}>
				Capturing Moments<br />
				<span class:list={["italic", heroImageUrl ? "text-white/90" : "text-stone-600"]}>That Last Forever</span>
			</h1>
			<p id="hero-subtitle" class:list={["mt-8 text-lg sm:text-xl max-w-2xl mx-auto font-sans min-h-[4.5rem] transition-opacity duration-300", heroImageUrl ? "text-white/90" : "text-stone-600"]}>
				Award-winning photography specializing in portrait, landscape, and event photography that tells your unique story.
			</p>
		</div>
	</div>
	<div id="hero-ctas" class="hero-ctas-fixed">
		<div id="hero-picker-wrap" class="hero-picker-wrap">
			<div id="hero-picker" class="hero-picker" role="listbox" aria-label="Select category"></div>
		</div>
	</div>
</section>

<!-- Gallery -->
<section
	id="gallery"
	data-page="gallery"
	class="min-w-[100vw] w-[100vw] flex-shrink-0 snap-start flex flex-col justify-start overflow-y-auto py-16 px-4 sm:px-6 lg:px-8 bg-white"
>
	<div class="max-w-7xl mx-auto w-full">
		<div class="text-center mb-12">
			<h2 id="gallery-title" class="font-serif text-4xl sm:text-5xl font-light text-stone-900">Gallery</h2>
			<p id="gallery-subtitle" class="mt-4 text-stone-600 max-w-2xl mx-auto">
				A curated collection of moments frozen in time, each telling a unique story through light and shadow.
			</p>
		</div>
		<div
			id="gallery-tag-buttons"
			class="flex flex-nowrap gap-2 overflow-x-auto pb-4 -mx-1 [&::-webkit-scrollbar]:h-1.5 [&::-webkit-scrollbar-track]:bg-transparent [&::-webkit-scrollbar-thumb]:bg-stone-200 [&::-webkit-scrollbar-thumb]:rounded-full"
		></div>
		<div id="gallery-content">
			<p id="gallery-loading" class="text-center text-stone-500 py-12">Loading gallery…</p>
			<div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 hidden"></div>
			<p id="gallery-empty" class="hidden text-center text-stone-500 py-12">No photos yet. Check back soon.</p>
			<p id="gallery-empty-filter" class="hidden text-center text-stone-500 py-12">
				No photos with this tag.
			</p>
		</div>
	</div>
</section>

<!-- Services -->
<section
	id="services"
	data-page="services"
	class="min-w-[100vw] w-[100vw] flex-shrink-0 snap-start flex flex-col overflow-y-auto py-16 px-4 sm:px-6 lg:px-8 bg-stone-100"
>
	<div class="max-w-7xl mx-auto w-full">
		<div class="text-center mb-12">
			<h2 class="font-serif text-4xl sm:text-5xl font-light text-stone-900">Our Services</h2>
			<p class="mt-4 text-stone-600 max-w-2xl mx-auto">
				Discover our range of professional photography services tailored to capture your unique moments.
			</p>
		</div>
		<div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
			<div class="bg-white p-8 rounded-sm shadow-sm">
				<h3 class="font-serif text-xl font-semibold text-stone-900">Portrait Photography</h3>
				<p class="mt-3 text-stone-600">
					Timeless portraits that capture your personality, perfect for individuals, families, or professionals.
				</p>
				<p class="mt-4 font-medium text-stone-900">From $200 · 1-hour session</p>
			</div>
			<div class="bg-white p-8 rounded-sm shadow-sm">
				<h3 class="font-serif text-xl font-semibold text-stone-900">Event Photography</h3>
				<p class="mt-3 text-stone-600">
					Capture every moment of your special events, from weddings to corporate gatherings.
				</p>
				<p class="mt-4 font-medium text-stone-900">From $500 · 4-hour coverage</p>
			</div>
			<div class="bg-white p-8 rounded-sm shadow-sm">
				<h3 class="font-serif text-xl font-semibold text-stone-900">Landscape Photography</h3>
				<p class="mt-3 text-stone-600">
					Breathtaking nature and cityscape photography for your home or office decor.
				</p>
				<p class="mt-4 font-medium text-stone-900">From $350 · Half-day session</p>
			</div>
		</div>
	</div>
</section>

<!-- Contact -->
<section
	id="contact"
	data-page="contact"
	class="min-w-[100vw] w-[100vw] flex-shrink-0 snap-start flex flex-col justify-center overflow-y-auto py-16 px-4 sm:px-6 lg:px-8 bg-white"
>
	<div class="max-w-2xl mx-auto w-full">
		<div class="text-center mb-12">
			<h2 class="font-serif text-4xl sm:text-5xl font-light text-stone-900">Contact Us</h2>
			<p class="mt-4 text-stone-600">
				Get in touch to discuss your photography needs or book a session.
			</p>
		</div>
		<form class="space-y-6" action="#" method="post">
			<div>
				<label for="name" class="block text-sm font-medium text-stone-700 mb-2">Name</label>
				<input
					type="text"
					id="name"
					name="name"
					required
					class="w-full px-4 py-3 border border-stone-300 rounded-sm focus:ring-2 focus:ring-stone-400 focus:border-stone-400 outline-none transition-shadow"
					placeholder="Your name"
				/>
			</div>
			<div>
				<label for="email" class="block text-sm font-medium text-stone-700 mb-2">Email</label>
				<input
					type="email"
					id="email"
					name="email"
					required
					class="w-full px-4 py-3 border border-stone-300 rounded-sm focus:ring-2 focus:ring-stone-400 focus:border-stone-400 outline-none transition-shadow"
					placeholder="you@example.com"
				/>
			</div>
			<div>
				<label for="message" class="block text-sm font-medium text-stone-700 mb-2">Message</label>
				<textarea
					id="message"
					name="message"
					rows="5"
					required
					class="w-full px-4 py-3 border border-stone-300 rounded-sm focus:ring-2 focus:ring-stone-400 focus:border-stone-400 outline-none transition-shadow resize-none"
					placeholder="Tell me about your project..."
				></textarea>
			</div>
			<button
				type="submit"
				class="w-full sm:w-auto px-8 py-3 bg-stone-900 text-white font-medium rounded-sm hover:bg-stone-800 transition-colors"
			>
				Send Message
			</button>
		</form>
	</div>
</section>

<!-- About -->
<section
	id="about"
	data-page="about"
	class="min-w-[100vw] w-[100vw] flex-shrink-0 snap-start flex flex-col justify-center overflow-y-auto py-16 px-4 sm:px-6 lg:px-8 bg-stone-100"
>
	<div class="max-w-2xl mx-auto prose prose-stone">
		<h2 class="font-serif text-4xl font-light text-stone-900">About</h2>
		<p class="text-stone-600 mt-6">
			I'm a professional photographer specializing in portrait, landscape, and event photography.
			With years of experience, I blend technical expertise with creative vision to tell compelling visual stories.
		</p>
		<p class="text-stone-600 mt-4">
			<a href="/contact" class="text-stone-900 font-medium hover:underline">Get in touch</a> to discuss your project.
		</p>
	</div>
	<footer class="mt-16 pt-8 border-t border-stone-200 text-center text-stone-500 text-sm">
		&copy; {new Date().getFullYear()} Moments. All rights reserved.
	</footer>
</section>

<button
	type="button"
	id="prev-section-btn"
	class="section-nav-btn fixed left-0 z-40 px-6 py-4 flex items-center gap-3 bg-stone-900/70 hover:bg-stone-900 text-white/90 hover:text-white transition-all duration-300 group border-r border-white/10"
	style="bottom: 0px; width:50vw"
	aria-label="Previous section"
>
	<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:-translate-x-0.5 transition-transform duration-200">
		<path d="M19 12H5M12 19l-7-7 7-7" />
	</svg>
	<span class="text-xs uppercase tracking-[0.15em] font-medium" data-section-label>Home</span>
</button>

<button
	type="button"
	id="next-section-btn"
	class="section-nav-btn fixed right-0 z-40 px-6 py-4 flex items-center gap-3 bg-stone-900/70 hover:bg-stone-900 text-white/90 hover:text-white transition-all duration-300 group border-l border-white/10"
	style="bottom: 0px; width:50vw"
	aria-label="Next section"
>
	<span class="text-xs uppercase tracking-[0.15em] font-medium" data-section-label>Gallery</span>
	<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:translate-x-0.5 transition-transform duration-200">
		<path d="M5 12h14M12 5l7 7-7 7" />
	</svg>
</button>

<script define:vars={{ initialSection, initialTag }}>
	const SECTIONS = ['hero', 'gallery', 'services', 'contact', 'about'];
	const SECTION_LABELS = { hero: 'Home', gallery: 'Gallery', services: 'Services', contact: 'Contact', about: 'About' };
	const HERO_CAROUSEL_INTERVAL_MS = 5000;
	let skipScrollSync = false;
	let currentHeroTag = '';
	let heroSlides = [];
	let carouselIntervalId = null;
	let heroSectionInView = false;
	if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

	function pathToSection(path) {
		if (path === '/' || path === '') return 'hero';
		const p = path.replace(/^\//, '').split('/')[0];
		return SECTIONS.includes(p) ? p : 'hero';
	}

	function sectionToPath(section) {
		if (section === 'hero') return '/';
		if (section === 'gallery' && /^\/gallery\/[^/]+/.test(location.pathname)) return location.pathname;
		return `/${section}`;
	}

	function getSectionFromScroll(scrollEl) {
		const sectionWidth = scrollEl.scrollWidth / SECTIONS.length;
		const center = scrollEl.scrollLeft + scrollEl.clientWidth / 2;
		const index = Math.min(Math.max(0, Math.floor(center / sectionWidth)), SECTIONS.length - 1);
		return SECTIONS[index];
	}

	function scrollToSection(section, instant) {
		const el = document.getElementById(section);
		if (el) el.scrollIntoView({ behavior: instant ? 'instant' : 'smooth', inline: 'start', block: 'nearest' });
		const path = sectionToPath(section);
		if (location.pathname !== path) {
			history.pushState({ section }, '', path);
		}
		updateNavHighlight(section);
	}

	function updateNavHighlight(section) {
		document.querySelectorAll('.nav-scroll-link').forEach((a) => {
			const linkPath = a.getAttribute('href') || '/';
			const linkSection = pathToSection(linkPath);
			a.classList.toggle('nav-active', linkSection === section);
			a.setAttribute('aria-current', linkSection === section ? 'page' : null);
		});
		const idx = SECTIONS.indexOf(section);
		const prevBtn = document.getElementById('prev-section-btn');
		const nextBtn = document.getElementById('next-section-btn');
		if (prevBtn) {
			prevBtn.classList.toggle('opacity-0', idx <= 0);
			prevBtn.classList.toggle('pointer-events-none', idx <= 0);
			prevBtn.classList.toggle('-translate-x-2', idx <= 0);
			const prevLabel = prevBtn.querySelector('[data-section-label]');
			if (prevLabel && idx > 0) prevLabel.textContent = SECTION_LABELS[SECTIONS[idx - 1]];
		}
		if (nextBtn) {
			nextBtn.classList.toggle('opacity-0', idx >= SECTIONS.length - 1);
			nextBtn.classList.toggle('pointer-events-none', idx >= SECTIONS.length - 1);
			nextBtn.classList.toggle('translate-x-2', idx >= SECTIONS.length - 1);
			const nextLabel = nextBtn.querySelector('[data-section-label]');
			if (nextLabel && idx < SECTIONS.length - 1) nextLabel.textContent = SECTION_LABELS[SECTIONS[idx + 1]];
		}
	}

	function syncFromScroll() {
		if (skipScrollSync) return;
		const scroll = document.querySelector('main');
		if (!scroll) return;
		const section = getSectionFromScroll(scroll);
		const path = sectionToPath(section);
		updateNavHighlight(section);
		if (location.pathname !== path) {
			history.replaceState({ section }, '', path);
		}
	}

	function init() {
		const scroll = document.querySelector('main');
		const sectionPaths = ['/', '/gallery', '/services', '/contact', '/about'];

		if (initialSection && SECTIONS.includes(initialSection)) {
			skipScrollSync = true;
			scrollToSection(initialSection, true);
			setTimeout(() => {
				skipScrollSync = false;
				syncFromScroll();
			}, 800);
		} else {
			if (scroll) scroll.scrollLeft = 0;
			updateNavHighlight('hero');
		}

		document.addEventListener('click', (e) => {
			const link = e.target?.closest?.('.scroll-to-btn, .nav-scroll-link');
			if (!link) return;
			const path = (link.getAttribute('href') || '/').split('?')[0];
			if (sectionPaths.includes(path)) {
				e.preventDefault();
				scrollToSection(pathToSection(path));
			}
		});

		document.getElementById('hero')?.addEventListener('click', (e) => {
			const link = e.target?.closest?.('.hero-picker-item');
			if (!link) return;
			const tagSlug = link.getAttribute('data-tag-slug');
			if (!tagSlug) return;
			e.preventDefault();
			if (currentHeroTag === tagSlug) {
				window.location.href = `/gallery/${tagSlug}`;
				return;
			}
			currentHeroTag = tagSlug;
			loadGallery(tagSlug);
			scrollToSection('gallery');
			history.pushState({ section: 'gallery', tag: tagSlug }, '', `/gallery/${tagSlug}`);
		});

		const PICKER_ITEM_HEIGHT = 40;
		const PICKER_PADDING = 40;
		const PICKER_LANDING_MS = 1200;
		let pickerIsJumping = false;
		let pickerLandingUntil = 0;

		function renderPicker(slides, activeSlug) {
			const wrap = document.getElementById('hero-picker-wrap');
			const picker = document.getElementById('hero-picker');
			if (!wrap || !picker) return;
			const N = slides.length;
			if (N === 0) {
				picker.innerHTML = '';
				return;
			}
			const tripled = [...slides, ...slides, ...slides];
			const items = tripled.map((s) => {
				const slug = s.slug ?? '';
				const name = s.name ?? '';
				return `<button type="button" role="option" class="hero-picker-item" data-hero-cta="tag" data-tag-slug="${escapeHtml(slug)}">${escapeHtml(name)}</button>`;
			}).join('');
			picker.innerHTML = items;
			const idx = slides.findIndex((s) => (s.slug ?? '') === activeSlug);
			const startIdx = idx >= 0 ? idx : 0;
			const scrollToIdx = N + startIdx;
			picker.scrollTop = scrollToIdx * PICKER_ITEM_HEIGHT + PICKER_PADDING - (wrap.clientHeight / 2 - PICKER_ITEM_HEIGHT / 2);
			updatePickerFromScroll();
		}

		function updatePickerFromScroll() {
			const wrap = document.getElementById('hero-picker-wrap');
			const picker = document.getElementById('hero-picker');
			if (!wrap || !picker || heroSlides.length === 0) return;
			const N = heroSlides.length;
			const center = wrap.clientHeight / 2;
			picker.querySelectorAll('.hero-picker-item').forEach((el, i) => {
				const top = PICKER_PADDING + i * PICKER_ITEM_HEIGHT;
				const elCenter = top + PICKER_ITEM_HEIGHT / 2 - picker.scrollTop;
				const dist = Math.abs(center - elCenter);
				const t = Math.max(0, 1 - dist / center);
				const scale = 0.5 + t * 0.5;
				const opacity = 0.4 + t * 0.6;
				el.style.transform = `scale(${scale})`;
				el.style.opacity = String(opacity);
			});
		}

		function scrollPickerToSlide(activeSlug) {
			const wrap = document.getElementById('hero-picker-wrap');
			const picker = document.getElementById('hero-picker');
			if (!wrap || !picker || heroSlides.length === 0) return;
			const N = heroSlides.length;
			const idx = heroSlides.findIndex((s) => (s.slug ?? '') === activeSlug);
			if (idx >= 0) {
				pickerIsJumping = true;
				pickerLandingUntil = Date.now() + PICKER_LANDING_MS;
				const scrollToIdx = N + idx;
				const targetTop = scrollToIdx * PICKER_ITEM_HEIGHT + PICKER_PADDING - (wrap.clientHeight / 2 - PICKER_ITEM_HEIGHT / 2);
				picker.scrollTo({ top: targetTop, behavior: 'smooth' });
				updatePickerFromScroll();
				setTimeout(() => {
					pickerIsJumping = false;
					updatePickerFromScroll();
				}, PICKER_LANDING_MS);
			}
		}

		document.getElementById('hero-picker')?.addEventListener('scroll', () => {
			const wrap = document.getElementById('hero-picker-wrap');
			const picker = document.getElementById('hero-picker');
			if (!wrap || !picker || heroSlides.length === 0) return;
			updatePickerFromScroll();
			if (pickerIsJumping || Date.now() < pickerLandingUntil) return;
			const N = heroSlides.length;
			const center = wrap.clientHeight / 2;
			const scrollCenter = picker.scrollTop + center;
			const rawIdxFloat = (scrollCenter - PICKER_PADDING - PICKER_ITEM_HEIGHT / 2) / PICKER_ITEM_HEIGHT;
			const rawIdx = Math.round(rawIdxFloat);
			let idx = rawIdx;
			if (rawIdx < N) {
				pickerIsJumping = true;
				picker.scrollTop += N * PICKER_ITEM_HEIGHT;
				idx = rawIdx;
				requestAnimationFrame(() => { pickerIsJumping = false; });
			} else if (rawIdx >= 2 * N || rawIdxFloat >= 2 * N - 0.5) {
				pickerIsJumping = true;
				const scrollToIdx = N;
				const targetTop = scrollToIdx * PICKER_ITEM_HEIGHT + PICKER_PADDING - (wrap.clientHeight / 2 - PICKER_ITEM_HEIGHT / 2);
				picker.scrollTop = targetTop;
				idx = 0;
				requestAnimationFrame(() => { pickerIsJumping = false; });
			} else {
				idx = rawIdx - N;
			}
			idx = Math.max(0, Math.min(N - 1, idx));
			const slide = heroSlides[idx];
			if (slide && (slide.slug ?? '') !== currentHeroTag) {
				const prevIdx = heroSlides.findIndex((s) => (s.slug ?? '') === currentHeroTag);
				const direction = prevIdx >= 0 && idx < prevIdx ? 'prev' : 'next';
				currentHeroTag = slide.slug ?? '';
				applyHeroSlide(slide, direction);
			}
		});

		document.getElementById('gallery')?.addEventListener('click', (e) => {
			const link = e.target?.closest?.('.gallery-tag-link');
			if (!link) return;
			e.preventDefault();
			const href = link.getAttribute('href') || '';
			const tag = href === '/gallery' ? '' : href.replace(/^\/gallery\//, '').split('/')[0];
			loadGallery(tag);
			const newPath = tag ? `/gallery/${tag}` : '/gallery';
			history.pushState({ section: 'gallery', tag }, '', newPath);
			link.closest('#gallery-tag-buttons')?.querySelectorAll('.gallery-tag-link').forEach((l) => {
				const lHref = l.getAttribute('href') || '';
				const lTag = lHref === '/gallery' ? '' : lHref.replace(/^\/gallery\//, '').split('/')[0];
				const isActive = lTag === tag;
				l.classList.toggle('bg-stone-900', isActive);
				l.classList.toggle('text-white', isActive);
				l.classList.toggle('border-stone-900', isActive);
				l.classList.toggle('bg-white', !isActive);
				l.classList.toggle('text-stone-700', !isActive);
				l.classList.toggle('border-stone-300', !isActive);
			});
		});

		if (scroll) {
			let debounceId = 0;
			scroll.addEventListener('scroll', () => {
				clearTimeout(debounceId);
				debounceId = setTimeout(syncFromScroll, 120);
			});
		}

		window.addEventListener('popstate', (e) => {
			const section = e.state?.section ?? pathToSection(location.pathname);
			if (SECTIONS.includes(section)) scrollToSection(section, true);
			const tag = e.state?.tag ?? (location.pathname.startsWith('/gallery/') ? location.pathname.replace(/^\/gallery\//, '').split('/')[0] : '');
			loadGallery(tag);
		});

		function applyHeroSlide(slide, direction) {
			if (!slide) return;
			const { heroTitle, heroSubtitle, heroImageUrl, heroImageAlt } = slide;
			const wrap = document.getElementById('hero-image-wrap');
			const heroContent = document.getElementById('hero-content');
			const heroTitleEl = document.getElementById('hero-title');
			const heroSubtitleEl = document.getElementById('hero-subtitle');
			const heroTextWrap = document.getElementById('hero-text-wrap');
			const isNext = direction !== 'prev';

			if (heroTextWrap) heroTextWrap.style.opacity = '0';
			setTimeout(() => {
				if (heroTitleEl && heroTitle) {
					const parts = String(heroTitle).split(' | ');
					heroTitleEl.innerHTML = parts.length > 1
						? escapeHtml(parts[0]) + '<br /><span class="italic">' + escapeHtml(parts.slice(1).join(' | ')) + '</span>'
						: escapeHtml(heroTitle);
				}
				if (heroSubtitleEl && heroSubtitle) heroSubtitleEl.textContent = heroSubtitle;
				if (heroTextWrap) heroTextWrap.style.opacity = '1';
			}, 150);

			if (wrap) {
				const slideClass = isNext ? 'hero-image-slide-up' : 'hero-image-slide-down';
				if (heroImageUrl) {
					const baseLayer = wrap.querySelector('.hero-image-base');
					const incomingHtml = `<div class="hero-image-incoming absolute inset-0 z-10"><img src="${escapeHtml(heroImageUrl)}" alt="${escapeHtml(heroImageAlt || '')}" class="w-full h-full object-cover ${slideClass}" /><div class="absolute inset-0 bg-stone-900/50" aria-hidden="true"></div></div>`;

					if (baseLayer) {
						wrap.insertAdjacentHTML('beforeend', incomingHtml);
						const incoming = wrap.querySelector('.hero-image-incoming');
						const img = incoming?.querySelector('img');
						img?.addEventListener('animationend', () => {
							baseLayer.remove();
							incoming?.classList.remove('hero-image-incoming');
							incoming?.classList.add('hero-image-base');
							incoming?.classList.remove('absolute', 'z-10');
						}, { once: true });
					} else {
						wrap.innerHTML = `<div class="hero-image-base absolute inset-0"><img id="hero-image" src="${escapeHtml(heroImageUrl)}" alt="${escapeHtml(heroImageAlt || '')}" class="w-full h-full object-cover ${slideClass}" /><div class="absolute inset-0 bg-stone-900/50" aria-hidden="true"></div></div>`;
					}

					if (heroContent) {
						heroContent.classList.add('text-white');
						heroContent.querySelector('h1')?.classList.replace('text-stone-900', 'text-white');
						heroContent.querySelector('h1 span')?.classList.replace('text-stone-600', 'text-white/90');
						heroContent.querySelector('p')?.classList.replace('text-stone-600', 'text-white/90');
					}
				} else {
					wrap.innerHTML = '';
					if (heroContent) {
						heroContent.classList.remove('text-white');
						heroContent.querySelector('h1')?.classList.replace('text-white', 'text-stone-900');
						heroContent.querySelector('h1 span')?.classList.replace('text-white/90', 'text-stone-600');
						heroContent.querySelector('p')?.classList.replace('text-white/90', 'text-stone-600');
					}
				}
			}
			scrollPickerToSlide(slide.slug ?? '');
		}

		function advanceCarousel() {
			if (heroSlides.length === 0) return;
			const currentIdx = heroSlides.findIndex((s) => s.slug === currentHeroTag);
			const nextIdx = (currentIdx + 1) % heroSlides.length;
			const nextSlide = heroSlides[nextIdx];
			currentHeroTag = nextSlide.slug;
			applyHeroSlide(nextSlide, 'next');
		}

		function prevSlide() {
			if (heroSlides.length === 0) return;
			const currentIdx = heroSlides.findIndex((s) => s.slug === currentHeroTag);
			const prevIdx = currentIdx <= 0 ? heroSlides.length - 1 : currentIdx - 1;
			const slide = heroSlides[prevIdx];
			currentHeroTag = slide.slug;
			applyHeroSlide(slide, 'prev');
		}

		function startCarousel() {
			if (carouselIntervalId || heroSlides.length <= 1) return;
			carouselIntervalId = setInterval(advanceCarousel, HERO_CAROUSEL_INTERVAL_MS);
		}

		function stopCarousel() {
			if (carouselIntervalId) {
				clearInterval(carouselIntervalId);
				carouselIntervalId = null;
			}
		}

		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					const isHero = entry.target.id === 'hero';
					if (entry.isIntersecting) {
						entry.target.classList.add('section-in-view');
						if (isHero) {
							heroSectionInView = true;
							startCarousel();
						}
					} else {
						entry.target.classList.remove('section-in-view');
						if (isHero) {
							heroSectionInView = false;
							stopCarousel();
						}
					}
				});
			},
			{ threshold: 0.2 }
		);
		SECTIONS.forEach((id) => {
			const el = document.getElementById(id);
			if (el) observer.observe(el);
		});

		let carouselResumeId = 0;
		const CAROUSEL_RESUME_DELAY_MS = 3000;
		document.addEventListener('wheel', (e) => {
			if (document.body.classList.contains('menu-open')) return;
			if (!heroSectionInView || heroSlides.length <= 1) return;
			if (Date.now() < pickerLandingUntil) {
				e.preventDefault();
				e.stopPropagation();
				return;
			}
			pickerLandingUntil = Date.now() + PICKER_LANDING_MS;
			e.preventDefault();
			e.stopPropagation();
			stopCarousel();
			clearTimeout(carouselResumeId);
			if (e.deltaY > 0) advanceCarousel();
			else if (e.deltaY < 0) prevSlide();
			carouselResumeId = setTimeout(() => {
				if (heroSectionInView && heroSlides.length > 1) startCarousel();
			}, CAROUSEL_RESUME_DELAY_MS);
		}, { passive: false, capture: true });

		let touchStartY = 0;
		let touchAdvanced = false;
		const TOUCH_THRESHOLD = 40;
		const heroEl = document.getElementById('hero');
		heroEl?.addEventListener('touchstart', (e) => {
			if (document.body.classList.contains('menu-open')) return;
			touchStartY = e.touches[0].clientY;
			touchAdvanced = false;
		}, { passive: true });
		heroEl?.addEventListener('touchmove', (e) => {
			if (document.body.classList.contains('menu-open')) return;
			if (!heroSectionInView || !heroSlides.length || heroSlides.length <= 1) return;
			if (Date.now() < pickerLandingUntil) {
				e.preventDefault();
				return;
			}
			if (touchAdvanced) {
				e.preventDefault();
				return;
			}
			const dy = e.touches[0].clientY - touchStartY;
			if (Math.abs(dy) > TOUCH_THRESHOLD) {
				touchAdvanced = true;
				stopCarousel();
				clearTimeout(carouselResumeId);
				if (dy > 0) prevSlide();
				else advanceCarousel();
				carouselResumeId = setTimeout(() => {
					if (heroSectionInView && heroSlides.length > 1) startCarousel();
				}, CAROUSEL_RESUME_DELAY_MS);
				e.preventDefault();
			}
		}, { passive: false });

		document.getElementById('prev-section-btn')?.addEventListener('click', () => {
			const scroll = document.querySelector('main');
			if (!scroll) return;
			const section = getSectionFromScroll(scroll);
			const idx = SECTIONS.indexOf(section);
			if (idx > 0) scrollToSection(SECTIONS[idx - 1]);
		});

		document.getElementById('next-section-btn')?.addEventListener('click', () => {
			const scroll = document.querySelector('main');
			if (!scroll) return;
			const section = getSectionFromScroll(scroll);
			const idx = SECTIONS.indexOf(section);
			if (idx < SECTIONS.length - 1) scrollToSection(SECTIONS[idx + 1]);
		});

		function loadGallery(tag) {
			currentHeroTag = tag;
			const url = tag ? `/api/gallery.json?tag=${encodeURIComponent(tag)}` : '/api/gallery.json';
			const gridEl = document.getElementById('gallery-grid');
			const loadingEl = document.getElementById('gallery-loading');
			const emptyEl = document.getElementById('gallery-empty');
			const emptyFilterEl = document.getElementById('gallery-empty-filter');
			const tagContainer = document.getElementById('gallery-tag-buttons');
			if (loadingEl) loadingEl.classList.remove('hidden');
			if (gridEl) gridEl.classList.add('hidden');
			if (emptyEl) emptyEl.classList.add('hidden');
			if (emptyFilterEl) emptyFilterEl.classList.add('hidden');
			fetch(url)
				.then((r) => (r.ok ? r.json() : Promise.reject(new Error('Failed to load gallery'))))
				.then(async (data) => {
					const { galleryItems = [], topTags = [], heroTitle: apiHeroTitle, heroSubtitle: apiHeroSubtitle, heroImageUrl: apiHeroUrl, heroImageAlt: apiHeroAlt } = data;
					const galleryTitleEl = document.getElementById('gallery-title');
					const gallerySubtitleEl = document.getElementById('gallery-subtitle');
					if (galleryTitleEl) {
						const tagInfo = tag ? topTags.find((t) => t.slug === tag) : null;
						galleryTitleEl.textContent = tagInfo ? tagInfo.name : 'Gallery';
					}
					if (gallerySubtitleEl) {
						gallerySubtitleEl.textContent = apiHeroSubtitle ?? 'A curated collection of moments frozen in time, each telling a unique story through light and shadow.';
					}
					if (loadingEl) loadingEl.classList.add('hidden');
					const defaultData = tag ? await fetch('/api/gallery.json').then((r) => (r.ok ? r.json() : null)) : data;
					const tagSlides = await Promise.all(
						topTags.map((t) =>
							tag === t.slug
								? Promise.resolve({ slug: t.slug, name: t.name, heroTitle: apiHeroTitle, heroSubtitle: apiHeroSubtitle, heroImageUrl: apiHeroUrl, heroImageAlt: apiHeroAlt })
								: fetch(`/api/gallery.json?tag=${encodeURIComponent(t.slug)}`)
										.then((r) => (r.ok ? r.json() : null))
										.then((d) => d ? { slug: t.slug, name: t.name, heroTitle: d.heroTitle, heroSubtitle: d.heroSubtitle, heroImageUrl: d.heroImageUrl, heroImageAlt: d.heroImageAlt } : null)
						)
					);
					heroSlides = tagSlides.filter(Boolean);
					const displaySlide = heroSlides.length > 0 && !tag ? heroSlides[0] : (tag ? heroSlides.find((s) => s.slug === tag) : null);
					const displayHero = displaySlide ?? defaultData;
					const displayTitle = displayHero?.heroTitle ?? apiHeroTitle;
					const displaySubtitle = displayHero?.heroSubtitle ?? apiHeroSubtitle;
					const displayUrl = displayHero?.heroImageUrl ?? apiHeroUrl;
					const displayAlt = displayHero?.heroImageAlt ?? apiHeroAlt;
					if (heroSlides.length > 0 && !tag) {
						currentHeroTag = heroSlides[0].slug ?? '';
					}
					const wrap = document.getElementById('hero-image-wrap');
					const heroContent = document.getElementById('hero-content');
					const heroTitleEl = document.getElementById('hero-title');
					const heroSubtitleEl = document.getElementById('hero-subtitle');
					if (heroTitleEl && displayTitle) {
						const parts = String(displayTitle).split(' | ');
						heroTitleEl.innerHTML = parts.length > 1
							? escapeHtml(parts[0]) + '<br /><span class="italic">' + escapeHtml(parts.slice(1).join(' | ')) + '</span>'
							: escapeHtml(displayTitle);
					}
					if (heroSubtitleEl && displaySubtitle) {
						heroSubtitleEl.textContent = displaySubtitle;
					}
					if (wrap) {
						if (displayUrl) {
							wrap.innerHTML = `<div class="hero-image-base absolute inset-0"><img id="hero-image" src="${escapeHtml(displayUrl)}" alt="${escapeHtml(displayAlt || '')}" class="w-full h-full object-cover" /><div class="absolute inset-0 bg-stone-900/50" aria-hidden="true"></div></div>`;
							if (heroContent) {
								heroContent.classList.add('text-white');
								heroContent.querySelector('h1')?.classList.replace('text-stone-900', 'text-white');
								heroContent.querySelector('h1 span')?.classList.replace('text-stone-600', 'text-white/90');
								heroContent.querySelector('p')?.classList.replace('text-stone-600', 'text-white/90');
							}
						} else {
							wrap.innerHTML = '';
							if (heroContent) {
								heroContent.classList.remove('text-white');
								heroContent.querySelector('h1')?.classList.replace('text-white', 'text-stone-900');
								heroContent.querySelector('h1 span')?.classList.replace('text-white/90', 'text-stone-600');
								heroContent.querySelector('p')?.classList.replace('text-white/90', 'text-stone-600');
							}
						}
					}
					renderPicker(heroSlides, currentHeroTag);
					if (tagContainer && !tagContainer.innerHTML.trim() && (galleryItems.length > 0 || topTags.length > 0)) {
						const currentTag = tag;
						const allActive = !currentTag;
						const allClasses = allActive ? 'gallery-tag-link flex-shrink-0 px-4 py-2 text-sm font-medium rounded-sm bg-stone-900 text-white hover:bg-stone-800 transition-colors whitespace-nowrap border border-stone-900 no-underline' : 'gallery-tag-link flex-shrink-0 px-4 py-2 text-sm font-medium rounded-sm border border-stone-300 text-stone-700 hover:bg-stone-100 hover:border-stone-400 transition-colors whitespace-nowrap bg-white no-underline';
						const tagButtons =
							`<a href="/gallery" class="${allClasses}">All</a>` +
							topTags
								.map((t) => {
									const isActive = currentTag === t.slug;
									const classes = isActive ? 'gallery-tag-link flex-shrink-0 px-4 py-2 text-sm font-medium rounded-sm bg-stone-900 text-white hover:bg-stone-800 transition-colors whitespace-nowrap border border-stone-900 no-underline' : 'gallery-tag-link flex-shrink-0 px-4 py-2 text-sm font-medium rounded-sm border border-stone-300 text-stone-700 hover:bg-stone-100 hover:border-stone-400 transition-colors whitespace-nowrap bg-white no-underline';
									return `<a href="/gallery/${escapeHtml(t.slug)}" class="${classes}">${escapeHtml(t.name)}</a>`;
								})
								.join('');
						tagContainer.innerHTML = tagButtons;
					} else if (tagContainer && tagContainer.innerHTML.trim()) {
						tagContainer.querySelectorAll('.gallery-tag-link').forEach((l) => {
							const lHref = l.getAttribute('href') || '';
							const lTag = lHref === '/gallery' ? '' : lHref.replace(/^\/gallery\//, '').split('/')[0];
							const isActive = lTag === tag;
							l.classList.toggle('bg-stone-900', isActive);
							l.classList.toggle('text-white', isActive);
							l.classList.toggle('border-stone-900', isActive);
							l.classList.toggle('bg-white', !isActive);
							l.classList.toggle('text-stone-700', !isActive);
							l.classList.toggle('border-stone-300', !isActive);
						});
					}
					// Scroll active tag into center within tag container only (avoid scrolling main)
					if (tagContainer) {
						const activeLink = Array.from(tagContainer.querySelectorAll('.gallery-tag-link')).find((l) => {
							const href = l.getAttribute('href') || '';
							const lTag = href === '/gallery' ? '' : href.replace(/^\/gallery\//, '').split('/')[0];
							return lTag === tag;
						});
						if (activeLink) {
							const targetScroll = activeLink.offsetLeft - (tagContainer.clientWidth / 2) + (activeLink.offsetWidth / 2);
							tagContainer.scrollTo({ left: Math.max(0, targetScroll), behavior: 'smooth' });
						}
					}
					if (gridEl) {
						gridEl.innerHTML = galleryItems
							.map(
								(item) =>
									`<a href="/gallery/${escapeHtml(item.albumSlug)}" data-gallery-item data-tag-slugs="${escapeHtml((item.tagSlugs || []).join(' '))}" class="group block aspect-square overflow-hidden rounded-sm bg-stone-200"><img src="${escapeHtml(item.thumbUrl)}" alt="${escapeHtml(item.albumName)}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" /></a>`,
							)
							.join('');
						gridEl.classList.toggle('hidden', galleryItems.length === 0);
					}
					if (emptyEl) emptyEl.classList.toggle('hidden', galleryItems.length > 0);
					if (emptyFilterEl) emptyFilterEl.classList.toggle('hidden', galleryItems.length > 0 || !tag);
					if (heroSectionInView && heroSlides.length > 1) startCarousel();
				})
				.catch(() => {
					if (loadingEl) loadingEl.classList.add('hidden');
					if (emptyEl) {
						emptyEl.textContent = 'Unable to load gallery. Please try again later.';
						emptyEl.classList.remove('hidden');
					}
				});
		}

		// Initial fetch (use initialTag from URL when on /gallery/[tag])
		loadGallery(typeof initialTag !== 'undefined' ? initialTag : '');
	}

	function escapeHtml(s) {
		const div = document.createElement('div');
		div.textContent = s;
		return div.innerHTML;
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init);
	} else {
		init();
	}
</script>
